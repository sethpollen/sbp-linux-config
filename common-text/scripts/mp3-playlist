#!/bin/bash

# Join the input file names into an output file name.
output_name=
for f in "${@}"; do
  # Remove the .mp3 suffix.
  f="$(basename "${f}" .mp3)"

  # Join the names into a long name.
  if [ ! -z "${output_name}" ]; then
    output_name="${output_name}__"
  fi
  output_name="${output_name}${f}"
done

if [ -z "${output_name}" ]; then
  echo "No inputs"
  exit 1
fi

# Construct an array of input files which can actually be passed to sox.
# Sox doesn't like mp3wrap'd files, so we have to try mp3splt'ing them.
tempdir="./mp3-playlist-temp"
for f in "${@}"; do
  rm -rf "${tempdir}"
  if mp3splt -w -d "${tempdir}" "${f}"; then
    # mp3splt succeeded. Merge its outputs and overwrite the original file.
    sox "${tempdir}"/* "${f}" || exit 1
  fi
done

echo "Building ${output_name}.mp3"
sox "${@}" "${output_name}.mp3" || exit 1
